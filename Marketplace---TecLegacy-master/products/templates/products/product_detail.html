{% extends 'base.html' %}

{% block title %}{{ product.name }} - TecLegacy{% endblock %}

{% block content %}
<div class="row mb-5">
    <!-- Breadcrumb -->
    <div class="col-12 mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'products:index' %}">Inicio</a></li>
                <li class="breadcrumb-item"><a href="{% url 'products:product_list' %}">Productos</a></li>
                <li class="breadcrumb-item"><a href="{% url 'products:products_by_category' product.category.slug %}">{{ product.category.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
            </ol>
        </nav>
    </div>

    <!-- Imagen del producto -->
    <div class="col-md-6 mb-4">
        <div class="product-image-container">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid product-detail-image">
            {% if product.is_featured %}
            <div class="product-badge-large">Destacado</div>
            {% endif %}
        </div>
    </div>

    <!-- Información del producto -->
    <div class="col-md-6">
        <h1 class="product-title text-light">{{ product.name }}</h1>

        <div class="product-price my-3">
            <span class="h2 text-light">${{ product.price }}</span>
            {% if product.is_available %}
                <span class="badge bg-success ms-2">Disponible</span>
            {% else %}
                <span class="badge bg-danger ms-2">Agotado</span>
            {% endif %}
        </div>

        <div class="product-description my-4 text-light">
            {{ product.description|linebreaks }}
        </div>

        {% if product.is_available %}
    <form id="add-to-cart-form"
          data-url="{% url 'cart:add_to_cart' product.id %}"
          method="post"
          class="add-to-cart-form mb-4">
        {% csrf_token %}

        <p>
            <strong>Talla:</strong>
            <select name="size" id="size-select">
                <option value="">Seleccione una talla</option>
                {% for size in product.sizes.all %}
                <option value="{{ size.id }}">{{ size.name }}</option>
                {% empty %}
                <option value="">No hay tallas disponibles</option>
                {% endfor %}
            </select>
        </p>

        <p>
            <strong>Color:</strong>
            <select name="color" id="color-select">
                <option value="">Seleccione un color</option>
                {% for color in product.colors.all %}
                <option value="{{ color.id }}">{{ color.name }}</option>
                {% empty %}
                <option value="">No hay colores disponibles</option>
                {% endfor %}
            </select>
        </p>

        <p><strong>Tipo:</strong> {{ product.get_gender_display }}</p>

        <div class="row g-3 align-items-center">
            <div class="col-auto">
                <label for="quantity-{{ product.id }}" class="col-form-label text-light">Cantidad:</label>
            </div>
            <div class="col-auto">
                <div class="input-group">
                    <button type="button" class="btn btn-outline-secondary quantity-btn" data-action="decrease">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="quantity-{{ product.id }}" name="quantity" class="form-control text-center"
                           value="1" min="1" max="{{ product.stock }}">
                    <button type="button" class="btn btn-outline-secondary quantity-btn" data-action="increase">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-cart-plus me-2"></i> Añadir al Carrito
                </button>
            </div>
        </div>
    </form>

    {% else %}
        <div class="alert alert-warning">
            Este producto está temporalmente agotado. Vuelve a revisar más tarde.
        </div>
        {% endif %}

        <!-- Información adicional -->
        <div class="product-meta mt-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Información del producto</h5>
                    <ul class="list-unstyled">
                        <li><strong>Categoría:</strong> {{ product.category.name }}</li>
                        <li><strong>Disponibilidad:</strong> {% if product.is_available %}En stock ({{ product.stock }} disponibles){% else %}Agotado{% endif %}</li>
                        <li><strong>ID del producto:</strong> #{{ product.id }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Productos relacionados -->
{% if related_products %}
<div class="row mt-5">
    <div class="col-12">
        <h2 class="text-light mb-4">Productos Relacionados</h2>
    </div>

    {% for related in related_products %}
    <div class="col-md-3 mb-4">
        <div class="card h-100 product-card">
            <a href="{{ related.get_absolute_url }}">
                <img src="{{ related.image.url }}" alt="{{ related.name }}" class="card-img-top product-image">
            </a>
            <div class="card-body">
                <h5 class="card-title">{{ related.name }}</h5>
                <p class="card-text text-truncate">{{ related.description|truncatechars:60 }}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <strong class="price">${{ related.price }}</strong>
                    <button class="btn btn-primary btn-sm add-to-cart-btn" data-product-id="{{ related.id }}">
                        <i class="fas fa-cart-plus"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('add-to-cart-form');
    const cartCount = document.getElementById('cart-items-count'); // contador en el navbar

    form.addEventListener('submit', async function (e) {
        e.preventDefault(); // evita recargar la página

        const url = form.dataset.url;
        const formData = new FormData(form);

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // ✅ Actualiza el contador del carrito en el navbar
            if (cartCount && data.cart_items_count !== undefined) {
                cartCount.textContent = data.cart_items_count;
            }

            // ✅ Opcional: mostrar un mensaje visual de éxito
            const btn = form.querySelector('button[type="submit"]');
            btn.innerHTML = '<i class="fas fa-check"></i> Añadido!';
            btn.classList.replace('btn-primary', 'btn-success');
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-cart-plus me-2"></i> Añadir al Carrito';
                btn.classList.replace('btn-success', 'btn-primary');
            }, 1500);
        } else {
            alert("Ocurrió un error al añadir el producto al carrito.");
        }
    });
});
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Controles de cantidad
        const quantityInput = document.getElementById('quantity-{{ product.id }}');
        const quantityBtns = document.querySelectorAll('.quantity-btn');

        quantityBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.dataset.action;
                let currentValue = parseInt(quantityInput.value);

                if (action === 'increase' && currentValue < {{ product.stock }}) {
                    quantityInput.value = currentValue + 1;
                } else if (action === 'decrease' && currentValue > 1) {
                    quantityInput.value = currentValue - 1;
                }
            });
        });
    });
</script>

<style>
select {
    padding: 5px 10px;
    font-size: 16px;
    border-radius: 5px;
    border: 1px solid #ccc;
    appearance: none; /* elimina flecha nativa en algunos navegadores */
    background: url('data:image/svg+xml;utf8,<svg fill="black" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 10px center;
    background-color: #fff;
}
</style>

{% endblock %}